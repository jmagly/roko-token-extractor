<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROKO Token Data API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            margin: 0;
            padding: 20px;
            color: black;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border: 2px solid #d0d0d0;
            border-radius: 20px;
            overflow: hidden;
        }
        .header {
            background: white;
            color: black;
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #d0d0d0;
        }
        h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: bold;
        }
        h2, h3 {
            color: black;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        .subtitle {
            margin-top: 10px;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
            background: white;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat {
            background: white;
            padding: 20px;
            border: 2px solid #d0d0d0;
            border-radius: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: black;
        }
        .stat-label {
            color: black;
            margin-top: 5px;
            font-size: 0.9em;
            opacity: 0.7;
        }
        .api-endpoint {
            background: white;
            padding: 15px;
            border: 2px solid #d0d0d0;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            color: black;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border: 2px solid #d0d0d0;
            border-radius: 10px;
            background: white;
            color: black;
            font-size: 0.9em;
            margin-left: 10px;
            font-weight: bold;
        }
        .error {
            background: black;
            color: white;
        }
        .loading {
            background: white;
            color: black;
            border-style: dashed;
        }
        .cache-info {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 2px solid #d0d0d0;
            border-radius: 10px;
            font-size: 0.9em;
            color: black;
        }
        .refresh-btn {
            background: white;
            color: black;
            border: 2px solid #d0d0d0;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        .refresh-btn:hover {
            background: #f5f5f5;
            color: black;
        }
        .last-updated {
            color: black;
            font-size: 0.9em;
            margin-top: 10px;
            opacity: 0.7;
        }
        pre {
            background: white !important;
            border: 2px solid #d0d0d0 !important;
            border-radius: 10px !important;
            padding: 15px !important;
            color: black !important;
        }
        textarea {
            background: white !important;
            color: black !important;
            border: 2px solid #d0d0d0 !important;
            border-radius: 10px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™ô ROKO Token Data</h1>
            <div class="subtitle">Blockchain data updated every 15 minutes</div>
        </div>
        <div class="content">
            <h2>Token Metrics</h2>
            <div class="stats" id="stats">
                <div class="stat">
                    <div class="stat-value" id="price">-</div>
                    <div class="stat-label">Price (USD)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="ethPrice">-</div>
                    <div class="stat-label">Price (ETH)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="marketcap">-</div>
                    <div class="stat-label">Market Cap</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="tvl">-</div>
                    <div class="stat-label">Total Value Locked</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="volume">-</div>
                    <div class="stat-label">24h Volume</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="volume7d">-</div>
                    <div class="stat-label">7d Volume</div>
                </div>
            </div>

            <h3>Additional Token Metrics</h3>
            <div class="stats" id="additionalStats">
                <div class="stat">
                    <div class="stat-value" id="totalSupply">-</div>
                    <div class="stat-label">Total Supply</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="circSupply">-</div>
                    <div class="stat-label">Circulating Supply</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="treasuryPct">-</div>
                    <div class="stat-label">Treasury Holdings</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="ethRatio">-</div>
                    <div class="stat-label">ROKO per ETH</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="poolCount">-</div>
                    <div class="stat-label">Active Pools</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="ethUsdPrice">-</div>
                    <div class="stat-label">ETH Price</div>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated"></div>
            <div style="font-size: 0.8em; color: #888; margin-top: 5px;" id="connectionStatus"></div>

            <h3>API Endpoint</h3>
            <div class="api-endpoint" id="endpoint"></div>

            <div class="cache-info">
                <strong>üöÄ Caching Information:</strong><br>
                ‚Ä¢ Data updates every 15 minutes automatically<br>
                ‚Ä¢ ETags are used for efficient caching (based on data timestamp)<br>
                ‚Ä¢ Browser cache: 15 minutes (must-revalidate)<br>
                ‚Ä¢ CDN-friendly with proper cache headers<br>
                <span id="cacheStatus"></span>
            </div>

            <h3>Raw JSON Data</h3>
            <textarea id="jsonData" readonly style="width: calc(100% - 34px); height: 400px; font-family: 'Courier New', monospace; background: white; color: black; padding: 15px; border-radius: 10px; border: 2px solid #d0d0d0; resize: vertical; white-space: pre; overflow: auto; box-sizing: content-box;">Loading...</textarea>

            <button class="refresh-btn" style="margin-top: 10px;" onclick="copyToClipboard()">Copy JSON</button>
            <span id="copyStatus" style="margin-left: 10px; color: black; font-weight: bold; display: none;">‚úì Copied!</span>

            <h3>Integration Example</h3>
            <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto;">
fetch('<span id="apiUrl"></span>')
  .then(response => response.json())
  .then(data => {
    console.log('Token Price:', data.pricing.usd_per_token);
    console.log('Market Cap:', data.pricing.market_cap_usd);
    console.log('TVL:', data.tvl.total_tvl_usd);
  });
            </pre>
        </div>
    </div>

    <script>
        const baseUrl = window.location.origin;
        const endpoint = `${baseUrl}/price`;

        document.getElementById('endpoint').textContent = endpoint;
        document.getElementById('apiUrl').textContent = endpoint;

        let lastEtag = null;

        async function fetchData(forceRefresh = false) {
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.textContent = '‚ü≥ Updating...';

            try {
                const headers = {};
                if (lastEtag) {
                    headers['If-None-Match'] = lastEtag;
                }

                const response = await fetch(endpoint, {
                    headers,
                    cache: forceRefresh ? 'no-cache' : 'default'
                });

                if (response.status === 304) {
                    // Not Modified - data hasn't changed since last fetch
                    document.getElementById('cacheStatus').innerHTML =
                        '<br><strong>‚úÖ Cache Status:</strong> Data unchanged (304 Not Modified)';
                    connectionStatus.textContent = '‚óè Connected';
                    // Don't return - let the cached version update the display if needed
                    // This ensures the UI stays in sync even if opened with stale browser cache
                }

                let data;
                if (response.status !== 304) {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const newEtag = response.headers.get('ETag');
                    if (newEtag) {
                        lastEtag = newEtag;
                    }

                    data = await response.json();
                } else {
                    // For 304, try to use cached response
                    const cachedResponse = await fetch(endpoint, {
                        cache: 'only-if-cached'
                    });
                    if (cachedResponse.ok) {
                        data = await cachedResponse.json();
                    } else {
                        // If no cache available, force a fresh fetch
                        return fetchData(true);
                    }
                }

                // Helper function to apply smaller font for numbers with many decimal places
                const formatWithFontSize = (elementId, value, prefix = '', suffix = '') => {
                    const element = document.getElementById(elementId);
                    element.textContent = prefix + value + suffix;

                    // Check if value has more than 9 decimal digits
                    const decimalPart = value.toString().split('.')[1];
                    if (decimalPart && decimalPart.length > 9) {
                        element.style.fontSize = '1.44em'; // 20% smaller
                    } else {
                        element.style.fontSize = '1.8em'; // Reset to normal
                    }
                };

                // Update primary stats
                const priceValue = parseFloat(data.pricing.usd_per_token).toFixed(8);
                formatWithFontSize('price', priceValue, '$');

                const ethPriceValue = parseFloat(data.pricing.eth_per_token).toFixed(12);
                formatWithFontSize('ethPrice', ethPriceValue, '', ' ETH');

                // Format numbers with commas
                const formatCurrency = (value) => {
                    const num = parseFloat(value.replace(/,/g, ''));
                    return num.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
                };

                document.getElementById('marketcap').textContent =
                    '$' + formatCurrency(data.pricing.market_cap_usd);
                document.getElementById('tvl').textContent =
                    '$' + formatCurrency(data.tvl.total_tvl_usd);
                document.getElementById('volume').textContent =
                    '$' + formatCurrency(data.volume.volume_24h_usd);
                document.getElementById('volume7d').textContent =
                    '$' + formatCurrency(data.volume.volume_7d_usd);

                // Update additional stats with proper formatting
                // For large whole numbers, show integers only with commas
                // Apply smaller font for numbers with >9 digits
                const formatLargeNumber = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    const numValue = Math.floor(parseFloat(value));
                    const formatted = numValue.toLocaleString();
                    element.textContent = formatted;

                    // If more than 9 digits (not counting commas), use smaller font
                    if (numValue >= 1000000000) {
                        element.style.fontSize = '1.44em'; // 20% smaller than 1.8em
                    } else {
                        element.style.fontSize = '1.8em'; // Reset to normal
                    }
                };

                formatLargeNumber('totalSupply', data.token.total_supply);
                formatLargeNumber('circSupply', data.token.circulating_supply);
                formatLargeNumber('ethRatio', data.pricing.token_eth_ratio);

                document.getElementById('treasuryPct').textContent =
                    data.token.treasury_percentage + '%';
                document.getElementById('poolCount').textContent =
                    data.tvl.pools_count;
                document.getElementById('ethUsdPrice').textContent =
                    '$' + parseFloat(data.pricing.eth_price_usd).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

                // Update raw JSON display
                document.getElementById('jsonData').value = JSON.stringify(data, null, 2);

                // Update last updated with local timezone conversion
                // Handle both formats: with and without timezone indicator
                const dateStr = data.datetime.endsWith('Z') || data.datetime.includes('+')
                    ? data.datetime
                    : data.datetime + 'Z';
                const utcDate = new Date(dateStr);
                const localDateString = utcDate.toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                });
                document.getElementById('lastUpdated').textContent =
                    'Last Updated: ' + localDateString;

                // Update cache status with truncated ETag
                if (response.status !== 304) {
                    const truncatedEtag = lastEtag ? lastEtag.substring(1, 9) + '...' : 'N/A';
                    document.getElementById('cacheStatus').innerHTML =
                        `<br><strong>‚úÖ Cache Status:</strong> Fresh data fetched<br>` +
                        `<strong>ETag:</strong> ${truncatedEtag}`;
                }

                connectionStatus.textContent = '‚óè Connected';

            } catch (error) {
                console.error('Error fetching data:', error);
                connectionStatus.textContent = '‚óã Disconnected';
                document.getElementById('cacheStatus').innerHTML =
                    `<br><strong>‚ùå Error:</strong> ${error.message}`;
            }
        }

        // Copy JSON to clipboard function
        function copyToClipboard() {
            const jsonText = document.getElementById('jsonData').value;
            navigator.clipboard.writeText(jsonText).then(() => {
                const statusSpan = document.getElementById('copyStatus');
                statusSpan.style.display = 'inline';
                setTimeout(() => {
                    statusSpan.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // Initial fetch
        fetchData();

        // Refresh every 15 minutes to match data update interval
        // This will check ETags and only update if data has actually changed
        setInterval(() => fetchData(), 15 * 60 * 1000);
    </script>
</body>
</html>